#!/bin/bash
# Creates a new git worktree for agentic development
#
# Usage:
#   new-worktree docs-ai/tasks/TODO-observability-baseline-emitter.md
#   new-worktree --branch feat/my-feature
#   new-worktree docs-ai/tasks/TODO-foo.md --from develop

set -e

# Path helpers
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPT_COPY_MANIFEST="$SCRIPT_DIR/new-worktree.copylist"
REPO_COPY_MANIFEST=""
COPY_MANIFEST_OVERRIDE=""
COPY_MANIFEST=""

# Defaults
REPO_ROOT="$HOME/projects/budgeat"
WORKTREES_DIR="$HOME/projects/budgeat.worktrees"
BASE_BRANCH="main"
BRANCH_NAME=""
TASK_FILE=""

# Parse arguments
while [[ $# -gt 0 ]]; do
    # Support grouping short flags, e.g. `-hfcFILE` (getopts-style).
    # Options that take a value follow getopts behavior:
    # -bVALUE uses VALUE; -b VALUE uses next argv.
    if [[ "${1:-}" =~ ^-[^-]{2,}$ ]]; then
        short_cluster="${1#-}"
        expanded=()
        for ((i=0; i<${#short_cluster}; i++)); do
            ch="${short_cluster:i:1}"
            case "$ch" in
                b|f|c)
                    if (( i + 1 < ${#short_cluster} )); then
                        expanded+=("-$ch" "${short_cluster:i+1}")
                    else
                        expanded+=("-$ch")
                    fi
                    break
                    ;;
                *)
                    expanded+=("-$ch")
                    ;;
            esac
        done
        set -- "${expanded[@]}" "${@:2}"
        continue
    fi

    case $1 in
        --branch|-b)
            BRANCH_NAME="$2"
            shift 2
            ;;
        --from|-f)
            BASE_BRANCH="$2"
            shift 2
            ;;
        --copylist|-c)
            COPY_MANIFEST_OVERRIDE="$2"
            shift 2
            ;;
        --help|-h)
            echo "Usage: new-worktree [TASK_FILE] [OPTIONS]"
            echo ""
            echo "Arguments:"
            echo "  TASK_FILE    Path to task file (e.g., docs-ai/tasks/TODO-foo.md)"
            echo "               Branch name is derived from filename"
            echo ""
            echo "You can use getopts-style short options, e.g. -fdevelop or -bfeat/my-feature"
            echo ""
            echo "Options:"
            echo "  --branch, -b NAME   Explicit branch name (overrides task file derivation)"
            echo "  --from, -f BRANCH   Base branch to create from (default: main)"
            echo "  --copylist, -c FILE Copy manifest file of repo-relative paths"
            echo "                    (default: $REPO_ROOT/.worktree.copylist if present,"
            echo "                              else $SCRIPT_COPY_MANIFEST)"
            echo "  --help, -h          Show this help"
            exit 0
            ;;
        *)
            # Assume it's a task file path
            TASK_FILE="$1"
            shift
            ;;
    esac
done

REPO_COPY_MANIFEST="$REPO_ROOT/.worktree.copylist"
if [[ -n "$COPY_MANIFEST_OVERRIDE" ]]; then
    COPY_MANIFEST="$COPY_MANIFEST_OVERRIDE"
elif [[ -f "$REPO_COPY_MANIFEST" ]]; then
    COPY_MANIFEST="$REPO_COPY_MANIFEST"
else
    COPY_MANIFEST="$SCRIPT_COPY_MANIFEST"
fi

# Derive branch name from task file if not explicitly provided
if [[ -z "$BRANCH_NAME" ]]; then
    if [[ -z "$TASK_FILE" ]]; then
        echo "Error: Provide a task file or --branch name"
        echo "Usage: new-worktree docs-ai/tasks/TODO-foo.md"
        exit 1
    fi

    # Extract filename without path and extension
    # e.g., docs-ai/tasks/TODO-observability-baseline-emitter.md -> TODO-observability-baseline-emitter
    filename=$(basename "$TASK_FILE" .md)

    # Remove TODO- prefix and convert to branch name
    # e.g., TODO-observability-baseline-emitter -> feat/observability-baseline-emitter
    branch_suffix="${filename#TODO-}"
    BRANCH_NAME="feat/$branch_suffix"
fi

# Create directory name from branch (replace / with -)
dir_name="${BRANCH_NAME//\//-}"
WORKTREE_PATH="$WORKTREES_DIR/$dir_name"

echo "==> Creating worktree"
echo "    Branch: $BRANCH_NAME"
echo "    From: $BASE_BRANCH"
echo "    Path: $WORKTREE_PATH"
echo ""

# Ensure worktrees directory exists
mkdir -p "$WORKTREES_DIR"

# Create the worktree
cd "$REPO_ROOT"
git fetch origin "$BASE_BRANCH"
git worktree add --no-track -b "$BRANCH_NAME" "$WORKTREE_PATH" "origin/$BASE_BRANCH"

echo ""
echo "==> Copying gitignored files"

trim() {
    local s="$1"
    # Trim leading whitespace
    s="${s#"${s%%[![:space:]]*}"}"
    # Trim trailing whitespace
    s="${s%"${s##*[![:space:]]}"}"
    printf '%s' "$s"
}

is_unsafe_relpath() {
    local p="$1"
    [[ -z "$p" ]] && return 0
    [[ "$p" == /* ]] && return 0
    [[ "$p" == ".." || "$p" == ../* || "$p" == */../* || "$p" == */.. ]] && return 0
    return 1
}

copy_relpath() {
    local relpath="$1"
    local src="$REPO_ROOT/$relpath"
    local dest="$WORKTREE_PATH/$relpath"

    if command -v rsync >/dev/null 2>&1; then
        (cd "$REPO_ROOT" && rsync -aR "$relpath" "$WORKTREE_PATH/")
        return 0
    fi

    mkdir -p "$(dirname "$dest")"
    if [[ -d "$src" ]]; then
        mkdir -p "$dest"
        cp -a "$src/." "$dest/"
    else
        cp -a "$src" "$dest"
    fi
}

if [[ -f "$COPY_MANIFEST" ]]; then
    echo "    Manifest: $COPY_MANIFEST"
    while IFS= read -r line || [[ -n "$line" ]]; do
        # Handle CRLF manifests
        line="${line%$'\r'}"
        relpath="$(trim "$line")"
        [[ -z "$relpath" ]] && continue
        [[ "$relpath" == \#* ]] && continue

        # Normalize directory entries like "models/" -> "models"
        relpath="${relpath%/}"

        if is_unsafe_relpath "$relpath"; then
            echo "    Skipping unsafe path in manifest: $relpath" >&2
            continue
        fi

        if [[ -e "$REPO_ROOT/$relpath" ]]; then
            copy_relpath "$relpath"
            echo "    Copied $relpath"
        fi
    done <"$COPY_MANIFEST"
else
    echo "    No manifest found at: $COPY_MANIFEST"
    echo "    Falling back to built-in defaults (.env, models/)"

    if [[ -f "$REPO_ROOT/.env" ]]; then
        cp "$REPO_ROOT/.env" "$WORKTREE_PATH/.env"
        echo "    Copied .env"
    fi

    if [[ -d "$REPO_ROOT/models" ]]; then
        mkdir -p "$WORKTREE_PATH/models"
        cp -r "$REPO_ROOT/models/"* "$WORKTREE_PATH/models/" 2>/dev/null || true
        echo "    Copied models/"
    fi
fi

echo ""
echo "==> Opening VS Code"
code "$WORKTREE_PATH/budgeat.code-workspace"

echo ""
echo "==> Running setup in new terminal (uv sync && just q)"
WIN_PATH=$(wslpath -w "$WORKTREE_PATH")
wt.exe -w 0 new-tab -p "Ubuntu" -d "$WIN_PATH" --title "Setup: $dir_name" wsl.exe -d Ubuntu -- bash -ic "cd '$WORKTREE_PATH' && uv sync && just q"

echo ""
echo "âœ“ Worktree created at: $WORKTREE_PATH"
echo "  Setup running in new terminal tab"
if [[ -n "$TASK_FILE" ]]; then
    echo ""
    echo "Task file reference for your agent:"
    echo "  @$TASK_FILE"
fi
